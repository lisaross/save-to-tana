function u(e){return e?e.replace(/\r?\n|\r/g," ").replace(/\s+/g," ").trim():""}function T(e,o){const t=e.split(/\n\n+/),n=[];let r="";for(const s of t)if((r+s).length>o)if(r&&(n.push(r),r=""),s.length>o){const l=s.match(/[^.!?]+[.!?]+/g)||[s];for(const i of l)if(i.length>o)for(let c=0;c<i.length;c+=o)n.push(i.slice(c,c+o));else(r+i).length>o?(n.push(r),r=i):r+=i}else r=s;else r+=(r?`

`:"")+s;return r&&n.push(r),n}function A(e,o,t,n){if(!e)throw new Error("SaveData is required");if(!o||!o.trim())throw new Error("Valid targetNodeId is required");if(!t||!t.trim())throw new Error("Valid supertagId is required");if(!n)throw new Error("TanaFieldIds is required");const r={name:u(e.title||e.url),supertags:[{id:t}],children:[]};if(e.url&&n.URL&&r.children.push({type:"field",attributeId:n.URL,children:[{dataType:"url",name:e.url}]}),e.author&&n.Author&&r.children.push({type:"field",attributeId:n.Author,children:[{name:u(e.author)}]}),e.description&&n.Description&&r.children.push({type:"field",attributeId:n.Description,children:[{name:u(e.description)}]}),e.notes&&e.notes.trim()&&r.children.push({name:u(e.notes)}),e.content&&n.Content){const s=u(e.content),l=4e3;let i=[];s.length>l?i=T(s,l).map(c=>({name:c})):i=[{name:s}],r.children.push({type:"field",attributeId:n.Content,children:i})}return{targetNodeId:o,nodes:[r]}}let p=0;const m=2e3;chrome.runtime.onInstalled.addListener(async()=>{console.log("Save to Tana extension installed"),await k()});chrome.omnibox.onInputStarted.addListener(()=>{console.log("Omnibox input started for Save to Tana")});chrome.omnibox.onInputChanged.addListener((e,o)=>{const t=[];e.trim()===""?(t.push({content:"quick",description:"Quick save current page"}),t.push({content:"notes",description:"Save with notes dialog"})):(t.push({content:e,description:`Save current page with title: "${e}"`}),t.push({content:"quick",description:"Quick save current page (original title)"})),o(t)});chrome.omnibox.onInputEntered.addListener(async(e,o)=>{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t?.id&&(e==="quick"?await g(t.id):e==="notes"?await f(t.id):await x(t.id,e.trim()))});chrome.commands.onCommand.addListener(async e=>{console.log(`ðŸŽ¹ KEYBOARD COMMAND RECEIVED: ${e}`),a(`Keyboard command received: ${e}`,"success");const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!o?.id){console.log("âŒ No active tab found"),a("No active tab found","error");return}switch(console.log(`ðŸ“‹ Processing command "${e}" for tab ${o.id}: ${o.title}`),e){case"quick-save":console.log("ðŸš€ Executing quick save..."),await g(o.id);break;case"save-with-notes":console.log("ðŸ“ Executing save with notes..."),await f(o.id);break;default:console.log(`â“ Unknown command: ${e}`),a(`Unknown command: ${e}`,"error")}});chrome.contextMenus.onClicked.addListener(async(e,o)=>{if(o?.id)switch(e.menuItemId){case"save-page":await g(o.id);break;case"save-with-notes":await f(o.id);break;case"save-selection":e.selectionText&&await D(o.id,e.selectionText);break;default:console.log(`Unknown context menu item: ${e.menuItemId}`)}});chrome.runtime.onMessage.addListener((e,o,t)=>{switch(console.log(`Message received: ${e.action}`,e),e.action){case"saveToTana":return E(e,t),!0;case"extractContent":return console.log("Extract content request forwarded to content script"),!1;case"injectOverlay":return h(e,t),!0;case"quickSave":return b(e,t),!0;case"saveWithNotes":return C(e,t),!0;default:return console.log(`Unknown message action: ${e.action}`),t({success:!1,error:"Unknown action"}),!1}});async function d(e){try{console.log("Starting saveToTana with data:",e);const t=Date.now()-p;if(t<m){const i=m-t;console.log(`Rate limiting: waiting ${i}ms before API call`),await new Promise(c=>setTimeout(c,i))}const n=await I();console.log("Retrieved configuration from storage:",n),v(n);const r=n.targetNodeId;console.log("Using target node ID:",r);const s=A(e,r,n.supertagId,n.tanaFieldIds);return console.log("Formatted Tana payload:",s),p=Date.now(),{success:!0,data:await S(s,n.apiKey)}}catch(o){throw console.error("Error saving to Tana:",o),o}}async function I(){return new Promise((e,o)=>{chrome.storage.sync.get(["apiKey","targetNodeId","supertagId","tanaFieldIds"],t=>{try{v(t),e(t)}catch(n){o(n)}})})}function v(e){if(!e.apiKey)throw new Error("API Token not configured. Please go to extension options and set up your configuration.");if(!e.supertagId)throw new Error("Supertag ID not configured. Please extract and save your Tana schema in options.");if(!e.targetNodeId)throw new Error("Target Node ID is required. Please go to options and specify a target node ID.");if(!e.tanaFieldIds)throw new Error("Field IDs not configured. Please extract and save your Tana schema in options.")}async function S(e,o){console.log("Sending request to Tana API...");const t=await fetch("https://europe-west1-tagr-prod.cloudfunctions.net/addToNodeV2",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(e)});if(console.log("API response status:",t.status),!t.ok){const r=await t.text();throw console.error("API error response:",r),new Error(`API error (${t.status}): ${r}`)}const n=await t.json();return console.log("API success response:",n),n}async function k(){try{await chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:"save-page",title:"Save page to Tana",contexts:["page"]}),chrome.contextMenus.create({id:"save-with-notes",title:"Save page to Tana with notes",contexts:["page"]}),chrome.contextMenus.create({id:"save-selection",title:"Save selection to Tana",contexts:["selection"]}),console.log("Context menus created successfully")}catch(e){console.error("Error setting up context menus:",e)}}async function E(e,o){try{const t=await d(e.data);o(t)}catch(t){o({success:!1,error:t instanceof Error?t.message:"Unknown error occurred"})}}async function h(e,o){try{await chrome.scripting.executeScript({target:{tabId:e.tabId},files:["content.js"]}),o({success:!0})}catch(t){console.error("Error injecting overlay:",t),o({success:!1,error:t instanceof Error?t.message:"Failed to inject overlay"})}}async function b(e,o){try{const t=await y(e.tabId);o(t)}catch(t){o({success:!1,error:t instanceof Error?t.message:"Quick save failed"})}}async function C(e,o){try{await h({action:"injectOverlay",tabId:e.tabId},t=>{t.success&&chrome.tabs.sendMessage(e.tabId,{action:"showNotesDialog"})}),o({success:!0})}catch(t){o({success:!1,error:t instanceof Error?t.message:"Save with notes failed"})}}async function g(e){try{const o=await y(e);o.success?a("Page saved to Tana successfully!","success"):a(o.error||"Save failed","error")}catch(o){console.error("Quick save error:",o),a("Quick save failed","error")}}async function f(e){try{await h({action:"injectOverlay",tabId:e},o=>{o.success?chrome.tabs.sendMessage(e,{action:"showNotesDialog"}):a("Failed to open notes dialog","error")})}catch(o){console.error("Save with notes error:",o),a("Failed to open notes dialog","error")}}async function x(e,o){try{const t=await w(e);if(t){o.trim()&&(t.notes=o);const n=await d(t);n.success?a(`Page saved to Tana with notes: "${o}"`,"success"):a(n.error||"Save failed","error")}else a("Failed to extract page content","error")}catch(t){console.error("Save with custom notes error:",t),a("Save with custom notes failed","error")}}async function D(e,o){try{const t=await w(e,{includeContent:!1});if(t){t.content=o,t.title=`Selection from ${t.title}`;const n=await d(t);n.success?a("Selection saved to Tana successfully!","success"):a(n.error||"Save failed","error")}}catch(t){console.error("Save selection error:",t),a("Save selection failed","error")}}async function y(e){try{const o=await w(e);if(!o)throw new Error("Failed to extract page content");return await d(o)}catch(o){return{success:!1,error:o instanceof Error?o.message:"Quick save failed"}}}async function w(e,o={}){return new Promise(t=>{const n={includeContent:o.includeContent??!0,includeTitle:o.includeTitle??!0};chrome.tabs.sendMessage(e,{action:"extractContent",options:n},r=>{if(chrome.runtime.lastError){console.error("Content extraction error:",chrome.runtime.lastError),t(null);return}r&&!r.error?t({url:r.url,title:r.title,author:r.author,description:r.description,content:r.content}):(console.error("Content extraction failed:",r?.message),t(null))})})}function a(e,o="success"){const t=`tana-${Date.now()}`;try{chrome.notifications.create(t,{type:"basic",iconUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",title:"Save to Tana",message:e}),setTimeout(()=>{chrome.notifications.clear(t)},3e3)}catch(n){console.log("Notification error (non-critical):",n),console.log(`Save to Tana: ${e}`)}}
//# sourceMappingURL=background.js.map
