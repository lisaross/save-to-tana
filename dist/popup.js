class g{saveButton;statusDiv;openOptionsLink;includeContentCheckbox;includeTitleCheckbox;notConfiguredDiv;progressContainer;progressFill;progressText;progressInterval=null;constructor(){this.saveButton=document.getElementById("save-button"),this.statusDiv=document.getElementById("status"),this.openOptionsLink=document.getElementById("open-options"),this.includeContentCheckbox=document.getElementById("include-content"),this.includeTitleCheckbox=document.getElementById("include-title"),this.notConfiguredDiv=document.getElementById("not-configured"),this.progressContainer=document.getElementById("progress-container"),this.progressFill=document.getElementById("progress-fill"),this.progressText=document.getElementById("progress-text"),this.initializePopup()}initializePopup(){this.checkConfiguration(),this.openOptionsLink.addEventListener("click",this.openOptions.bind(this)),this.saveButton.addEventListener("click",this.saveToTana.bind(this))}checkConfiguration(){chrome.storage.sync.get(["apiKey","supertagId","targetNodeId"],e=>{(!e.apiKey||!e.supertagId||!e.targetNodeId)&&(this.saveButton.disabled=!0,this.notConfiguredDiv.style.display="block")})}openOptions(){chrome.runtime.openOptionsPage()}saveToTana(){this.saveButton.disabled=!0,this.saveButton.textContent="Saving...",this.updateStatus({message:"",isError:!1}),this.showProgress("Extracting content...");const e={includeContent:this.includeContentCheckbox.checked,includeTitle:this.includeTitleCheckbox.checked};chrome.tabs.query({active:!0,currentWindow:!0},s=>{const t=s[0];if(!t.id){this.handleError("Cannot access the current tab.");return}this.extractContentFromPage(t.id,e)})}extractContentFromPage(e,s){this.ensureContentScriptLoaded(e).then(()=>{chrome.tabs.sendMessage(e,{action:"extractContent",options:s},t=>{if(chrome.runtime.lastError){this.handleError("Error communicating with the page: "+chrome.runtime.lastError.message);return}if(!t){this.handleError("No response from the page. Please refresh and try again.");return}if(t.error){this.handleError(t.message||"Error extracting content from the page");return}this.updateProgress(25,"Content extracted, sending to Tana..."),this.sendToBackground(t)})}).catch(t=>{console.log("Content script injection failed, trying fallback method:",t.message),this.updateProgress(15,"Trying alternative extraction method..."),this.extractContentWithFallback(e,s).then(o=>{this.updateProgress(25,"Content extracted, sending to Tana..."),this.sendToBackground(o)}).catch(o=>{this.handleError("Failed to extract content: "+t.message+". Please refresh the page and try again.")})})}async ensureContentScriptLoaded(e){return new Promise((s,t)=>{chrome.tabs.sendMessage(e,{action:"ping"},o=>{chrome.runtime.lastError?(console.log("Content script not found, attempting injection..."),chrome.tabs.get(e,n=>{if(chrome.runtime.lastError){t(new Error("Cannot access tab information"));return}if(n.url?.startsWith("chrome://")||n.url?.startsWith("chrome-extension://")||n.url?.startsWith("edge://")||n.url?.startsWith("moz-extension://")||n.url?.startsWith("about:")){t(new Error("Cannot inject content script on this type of page. Please try on a regular webpage."));return}chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]},r=>{if(chrome.runtime.lastError){t(new Error("Failed to inject content script: "+chrome.runtime.lastError.message));return}let i=0;const l=5,c=()=>{i++;const d=i*200;setTimeout(()=>{chrome.tabs.sendMessage(e,{action:"ping"},u=>{chrome.runtime.lastError?i<l?(console.log(`Content script ping attempt ${i} failed, retrying...`),c()):chrome.tabs.get(e,h=>{const a=h.url||"";a.includes("accounts.google.com")||a.includes("login.")||a.includes("auth.")||a.includes("secure.")?t(new Error("This page blocks content scripts for security. Please try on a different page.")):t(new Error("Content script injection failed. Please refresh the page and try again."))}):(console.log(`Content script responding after ${i} attempts`),s())})},d)};c()})})):(console.log("Content script already loaded and responding"),s())})})}async extractContentWithFallback(e,s){return new Promise((t,o)=>{chrome.scripting.executeScript({target:{tabId:e},func:n=>{try{const r={url:window.location.href,title:document.title,author:"",description:"",content:"",hierarchicalNodes:[]},i=document.querySelector('meta[name="author"]')||document.querySelector('meta[property="article:author"]');i&&(r.author=i.getAttribute("content")||"");const l=document.querySelector('meta[name="description"]')||document.querySelector('meta[property="og:description"]');if(l&&(r.description=l.getAttribute("content")||""),n.includeContent){const c=document.querySelector("main")||document.querySelector('[role="main"]')||document.querySelector(".main-content")||document.querySelector("#main-content")||document.querySelector(".content")||document.body;if(c){const d=c.querySelectorAll("h1, h2, h3, h4, h5, h6, p, li"),u=[];for(const h of d){const a=h.textContent?.trim();a&&a.length>10&&u.push({name:a})}u.length>0&&(r.hierarchicalNodes=[{name:r.title||"Page Content",supertags:[],children:u}])}}return(!n.includeTitle||!r.title)&&(r.title=r.url),r.title&&(r.title=r.title.replace(/\r?\n|\r/g," ").trim()),r}catch(r){return{url:window.location.href,title:document.title,author:"",description:"",content:"",error:!0,message:"Fallback extraction failed: "+(r instanceof Error?r.message:"Unknown error")}}},args:[s]},n=>{if(chrome.runtime.lastError){o(new Error("Fallback extraction failed: "+chrome.runtime.lastError.message));return}if(!n||!n[0]||!n[0].result){o(new Error("No data extracted from fallback method"));return}const r=n[0].result;if(r.error){o(new Error(r.message||"Fallback extraction error"));return}t(r)})})}sendToBackground(e){const s={action:"saveToTana",data:e},o=JSON.stringify(e).length>4500;if(o){this.updateProgress(30,"Preparing large content for upload...");let n=30;this.progressInterval=window.setInterval(()=>{n<85&&(n+=5,this.updateProgress(n,"Uploading content chunks..."))},800),chrome.runtime.sendMessage(s,r=>{this.clearProgressInterval(),this.handleBackgroundResponse(r,o)})}else this.updateProgress(50,"Uploading to Tana..."),chrome.runtime.sendMessage(s,n=>{this.handleBackgroundResponse(n,o)})}handleBackgroundResponse(e,s){if(this.saveButton.disabled=!1,this.saveButton.textContent="Save to Tana",!e){this.handleError("No response from the extension. Please try again.");return}if(!e.success){this.handleError(e.error||"Unknown error occurred");return}this.updateProgress(100,"Complete!");let t="Saved to Tana successfully!";e.data&&e.data.contentChunks>0&&(t=`Saved to Tana successfully! (Content split into ${e.data.contentChunks} parts due to size)`),setTimeout(()=>{this.hideProgress(),this.showSuccess(t)},500)}handleError(e){this.saveButton.disabled=!1,this.saveButton.textContent="Save to Tana",this.hideProgress(),this.updateStatus({message:e,isError:!0})}showSuccess(e){this.updateStatus({message:e,isError:!1}),setTimeout(()=>{this.updateStatus({message:"",isError:!1})},3e3)}updateStatus(e){this.statusDiv.textContent=e.message,this.statusDiv.className="status"+(e.isError?" error":e.message?" success":"")}showProgress(e="Processing..."){this.progressContainer.style.display="block",this.progressText.textContent=e,this.progressFill.style.width="0%",this.updateStatus({message:"",isError:!1})}updateProgress(e,s){this.progressFill.style.width=`${Math.min(100,Math.max(0,e))}%`,this.progressText.textContent=s}hideProgress(){this.clearProgressInterval(),this.progressContainer.style.display="none"}clearProgressInterval(){this.progressInterval!==null&&(window.clearInterval(this.progressInterval),this.progressInterval=null)}}document.addEventListener("DOMContentLoaded",()=>{new g});
//# sourceMappingURL=popup.js.map
